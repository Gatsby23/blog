% 桥梁模型贴纹理文档
% TANG ZhiXiong
% 2015-11-08

桥梁模型贴纹理文档
==================

概述
----

长沙桥梁裂缝检测项目需要将处理后的桥底影像、裂缝纹理贴到桥梁模型上，用于交互式展示。

生产环境
  ~ Windows x64 操作系统 + [CMake] + [Qt 4.8.6] + [OpenSceneGraph 3.4.0]

[CMake]: https://cmake.org/
[Qt 4.8.6]: http://mirrors.ustc.edu.cn/qtproject/archive/qt/4.8/4.8.6/
[OpenSceneGraph 3.4.0]: http://www.openscenegraph.org/

规范
----

参考 Cloud Compare

Element | Example
------- | -------
Class   | `ccMyClass`
File | `ccMyClass.h` and `ccMyClass.cpp`
Attribute/variable | `myAttribute`
Static attribute/variable | `s_myAttribute`
Method | `getMethod()`
Static method | `GetMethod()`
Structure | `myStruct`
Enumerator | `CC_MY_ENUMERATOR`
Macro | `MACRO_myMethod`
Const | `MY_CONSTANT`
Const (#define) | `MY_CONSTANT`

TODO
----

要做

:   * XML 工程化（桥梁的各个部分、纹理和 Pose，相应的 UI）
    * OpenGL 相关操作，四个视图以及各自视图下的操作并实现视角的切换
    * 二维纹理的交互操作
    * 模型 treeView
    
---

需求分析说明书
--------------

### 引言

需求分析很重要，是系统开发的……

本桥梁纹理系统的需求为后期系统开发和维护……

#### 目的

理清需求，明确开发工作，有助于系统的开发和维护。

#### 背景

桥梁纹理系统是桥梁裂缝检测系统的系统前端，提供方便的可视化手段来展示
整个桥梁裂缝检测系统的成果，即是系统宣传和公关工具，也有助于评价裂缝检测系统的
效果。

#### 业务术语

桥梁裂缝检测系统

:   本桥梁纹理系统的上游数据提供方，为本系统提供桥梁模型参数和纹理信息。

原始纹理图片

:   桥梁裂缝检测系统提供的桥面纹理图片，含位置信息、灰度信息和裂缝拓扑信息。

手工纹理图层

:   在原始纹理图片基础上，人工添加的纹理矢量线画图。

二维显示

:   实现桥梁裂缝原始纹理图片和手工纹理图层的加载和显示，并可执行缩放、平移等常规操作。

三维显示

:   桥梁模型和纹理平面的三维展示，有多个视图，有多种交互方式（Trackball，Bird view，etc）。
    并能对关键纹理贴图平面进行方便的二维显示。

二维编辑

:   在二维显示的基础上，在纹理图层上进行纹理编辑和保存。（可能需要额外的纹理编辑权限）

三维编辑

:   在三维显示的基础上，对纹理的放置位置和纹理贴合方式进行编辑修改。（可能需要额外的纹理编辑权限）

互操作

:   二维和三维联动，方便模型和纹理的查看和修改。

#### 参考资料

某需求分析参考（内部文档资料）

etc

### 硬件环境需求

#. 互联网接入
#. 主机（一般配置即可）
#. 存储（一般容量即可）

### 软件环境需求

操作系统

:   Windows 8/10

库

:   OpenCV、OpenSceneGraph 库

如果系统的服务器端提供 Web 浏览方式，软件环境需求可相应削弱至一台配置了支持 WebGL 浏览器的 PC 或一般智能机。

### 总体模型

桥梁纹理系统称为 `[btSystem]`，主要分为后台服务器端（`[btServer]`）和前台客户端（`[btClient]`），
总体模型为：

【桥梁纹理系统】 | `[btSystem]`

:   1. 【服务器端】 | `[btServer]`
        * 【认证模块】 | `[btAuth]`
        * 【数据库模块】 | `[btDatabase]`
        * 【日志模块】 | `[btLogger]`
        * 【服务端核心】 | `[btKernel]`
    2. 【客户端】 | `[btClient]`
        * 【客户代理模块】 | `[btAgent]`
        * 【模型编辑模块】 | `[btBridgeEditor]`
            + 【模型浏览模块】 | `[btBridgeViewer]`
        * 【纹理编辑模块】 | `[btTextureEditor]`
            + 【纹理浏览模块】 | `[btTextureViewer]`
        * 【会话日志模块】 | `[btSessionLogger]`

#### 概述

`[btServer]` 和 `[btClient]` 通过网络连接和通讯。下面简述各个模块的功能点。

（一）【服务器端】 | `[btServer]`

:   后端服务器，为前端服务，包括 `[btAuth]`、`[btDatabase]`、`[btLogger]`、`[btKernel]`。

    1. 【认证模块】 | `[btAuth]`
      ~ 1. 登录验证
      ~ 2. 权限控制
    2. 【数据库模块】 | `[btDatabash]`
      ~ 1. 存储桥梁参数
      ~ 2. 存储纹理信息
      ~ 3. 存储人工纹理图层信息
    3. 【日志模块】 | `[btLogger]`
      ~ 1. 记录匿名用户和登录用户的查看、检索和数据请求操作
      ~ 2. 记录登录用户的编辑变更记录
      ~ 3. 记录系统运行状况
    4. 【服务端核心】 | `[btKernel]`
      ~ 1. 统筹 `[btAuth]` 和 `[btDatabase]`
      ~ 2. 处理 `[btClient]` 的接入

（二）【客户端】 | `[btClient]`

:   前太客户端，包括 `[btAgent]`、`[btBridgeEditor]`、`[btTextureEditor]` 和 `[btSessionLogger]`

    1. 【客户代理模块】`[btAgent]`
      ~ 1. 用于连接服务器
      ~ 2. 请求数据
      ~ 3. 登录验证
      ~ 4. 请求编辑权限
    2. 【模型编辑模块】`[btBridgeEditor]`
      ~ 1. 模型编辑器
      ~ 2. 可从不同视角修改桥梁模型和纹理投影方式
      ~ 3. 包含 【模型浏览模块】 | `[btBridgeViewer]` 实现基本的模型显示功能
    3. 【纹理编辑模块】`[btTextureEditor]`
      ~ 1. 纹理图层编辑器
      ~ 2. 包含 【纹理浏览模块】 | `[btTextureViewer]` 子模块以显示二维纹理
    4. 【会话日志模块】`[btSessionLogger]`
      ~ 1. 记录当前会话下 client 的查看和编辑操作
      ~ 2. 用于提交变更

#### 使用流程

`btServer` 上线运行后，可以运行客户端软件连接服务器，查看桥梁模型和桥面纹理。基本使用流程是：

#. 安装客户端软件
#. 连接服务器，登录并获取权限
#. 获取桥梁列表
#. 通过从桥梁列表选取的方式或者模糊检索的方式，请求某一桥梁相关数据
#. 利用客户端的模型浏览模块和纹理浏览模块浏览当前桥梁
#. 记录用户的查询、浏览，用户可以通过使用历史快速打开桥梁模型或其具体的某一纹理平面
#. 如果有足够的权限，可以打开模型和纹理的编辑功能
#. 对模型和纹理编辑后，变更记录保存在当前的账户信息中（匿名用户的记录注销后自动删除）
#. 用户可以把对纹理进行的编辑提交到服务器，审核过后，变更会在系统范围内生效

### 定位和设计思路

本 `btSystem` 处于桥梁裂缝检测系统的下游，和客户联系紧密。
一方面要利用上游的桥梁和纹理数据为客户呈现活灵活现的三维、二维显示效果，
还要在实际运行过程中收集信息、向系统上游反馈数据质量的不足和改进点。

`btSystem` 所处的位置决定了其重要性。只有把 `btSystem` 做好，
出色地满足客户的各方面需求，桥梁裂缝检测系统才能得到应有的认可和好评。
如果本桥梁纹理系统做得不好、使用体验差，导致用户不满意，不仅是本系统的失败，
也是整个桥梁裂缝检测系统的失败。

（TODO：继续补充：论自我展示的重要性。）

鉴于 `btSystem` 的定位，在系统设计上，我们要：

#. 从**用户**角度出发
    * 提供易用的交互方式
    * 提供一定的容错能力，纠正非专业人士的误操作
    * 提供更简洁的 UI，避免暴露不必要的选择
#. 从后台为整个系统默默贡献**开发人员**的角度出发
    * 充分利用裂缝检测系统开发人员提供的桥梁模型参数和纹理信息
    * 反馈数据的优劣，提出数据改进意见
#. 从系统的**设计和维护**的角度出发
    * 设计应当简洁
    * 层次清晰、模块独立
    * 便于单元测试和集成测试
    * 即使开发人员频繁变动，也不会影响系统稳定性和开发进度
    * 便于项目提交

### 资源和共享需求

综合考虑客户、开发者、维护者、投资者的利益，我们将系统设计成
**中心管理**的方式，因为这种模式

#. 减轻了客户端的安装压力
#. 保护了系统数据不轻易流失
#. 便于权限管理，向普通用户隐藏高精度数据，向高级用户提供更优质服务和更多特权
#. 滚动式数据更新，让用户及时体验最新数据
#. 便于记录数据使用情况，分析用户浏览的特点，分析原始数据的优劣

是在**数据保护**和**系统推广**之间的折中选择。

### 应用功能需求

从 [总体模型](#总体模型) 中可以提炼出总体功能架构：

#. 登录
    * 可以匿名登录（或者不登录），但只有浏览权限
    * 登录，获得某一等级的权限
    * 社交网络分享某一桥体模型或者纹理模型，吸引更多用户
#. 浏览
    * 二维纹理浏览
        + 可对纹理贴图平移、缩放、放大查看
        + 可保存截图
        + 显示纹理贴图的信息
            - 图片格式、大小、日期（atime、ctime、mtime）
            - 人工纹理图层的修改者
            - 裂缝详细信息（支持排序、筛选）
    * 三维模型浏览
        + 切换交互方式（track-ball view，car-drive view 等）
        + 通过点击选中三维物体
        + 通过鼠标放大、缩小放大视角
    * 二维、三维互操作和联动
        + 通过在三维浏览器中点选模型平面查看纹理贴图
        + 通过在二维浏览器中选择纹理贴图跳转到三维模型的具体位置
#. 编辑
    * 二维纹理编辑
        + 在当前纹理图层上添加、删除裂缝
        + 修改某一裂缝
        + 备注某一裂缝
        + 裂缝应保存为矢量（比如 svg 格式）
    * 三维模型编辑
        + 直接修改模型参数
        + 手工微调模型位置（不同视角协助用户判断调整是否到位）
        + 调整纹理颜色融合（blend）的 alpha 值
        + 添加备注信息
#. 保存
    * 浏览记录保存在本地，不定期同步至服务器
    * 完全保存编辑记录，可重放
    * 可以将编辑记录绑定到自己的视图中，下次加载纹理、模型后会自动 patch 这个编辑，再显示编辑后的效果
    * 可以请求把这个 patch（编辑）提交到全系统范围，请求绑定全范围的纹理、模型加载后都将 patch 这个编辑，再显示之后的效果（全局生效）
    * （前两点把模型和纹理的编辑看成了一个对模型、纹理配置文本不断 patch 的过程，这些 patch 可以提交可以、共享，可以向服务器提交继而被接受或被否定）
#. 提交
    * 浏览和编辑记录保存在当前用户账户中，应及时提交至中心服务器
#. 系统无关
    * 设计合理的功能、布局、按钮以及必要的快捷键
    * 从示例中教用户如何使用（类似游戏设计中前几关告诉玩家游戏的方法）
    * 联系开发者，报告问题

总体功能架构图（略）

总体业务流程（概述、流程）

用例图（略）。

功能描述（略）。

### 系统性能需求

服务器端处理能力要求

:   `[btKernel]` 应能处理多并发访问，有用足够的 IO 带宽，
    对每个用户的响应时间小于一定阈值（比如：resThresh = 300ms）。
    
    `[btDatabase]` 支持查询优化。……
    
    `[btAuth]` 应能满足用户第三方登录需求，满足用户通过邮箱、手机重置密码的需求，
    认证响应时间小于一定阈值（比如 authThresh = 400ms）。
    
    `[btLogger]` 及时将所有信息记录下来。
    
客户端处理能力要求

:   `[btClient]` 应能保存一些离线数据，在偶然断网情况下也能浏览。

    `[btAgent]` 应能把本地账户信息（由 `[btSessionLogger]` 收集）提交到中心服务器。
    
    `[btBridgeEditor]` 和 `[btTextureEditor]` 应能充分利用计算机 GPU 能力，减少卡顿，
    并不应影响主界面消息循环线程。在三维浏览、编辑模块卡死时能重置这个模块。
    
    `[btSessionLogger]` 应能记录用户的浏览操作，保存在当前账户中。

系统稳定性指标

:   #. 7 x 24 小时工作，无宕机
    #. 平均年故障时间：< 1天
    #. 平均故障修复时间：< 10 min
    #. 最大故障修复时间：< 50 min

备份需求和策略

:   #. 一方面中心服务器选用磁盘阵列运行服务器程序、进行数据存储
    #. 另一方面，数据库要定期差异备份和完全备份
    #. 可以考虑选用第三方 CDN 云存储服务
      （避免自己考虑数据的安全性和并发访问能力）
    
### 系统测试需求

#### 测试指标

#. 从综合功能的角度，验证系统和用户需求的符合性；
#. 降低系统运行风险，降低系统运行和维护成本；
#. 通过测试找出系统瓶颈和协助系统调优，提升系统的整体性能；
#. 通过测试产生的数据，为今后的系统稳定可靠运行提供科学依据；
#. 保证系统的实用性、稳定性、可维护性、灵活性、可操作性。

#### 测试方法

系统功能性测试

:   完成情况 | 功能点 | 备注
    :------: | ------ | ----
    &#x2610; | 数据库 | null
    &#x2611; | 二维浏览 | null
    &#x2610; | 二维编辑 | null
    &#x2611; | 三维浏览 | null
    &#x2610; | 三维编辑 | null
    &#x2610; | 二维浏览 | null

    （系统功能性测试只是一个概略，
    在 [测试模块](#测试模块) 有具体每个功能点的测试情况）

业务性能测试

:   业务的完整性，和每个业务模块的可用性

单元测试、集成测试、系统测试、压力测试、etc

#### 测试模块

序号 | 系统 | 功能点 | 期望 | 测试结果 | 备注
---- | ---- | ------ | ---- | :---: | --- |
   1 | `[btServer]` | Web 服务 | 接收请求并应答 | &#x2610; | null
   2 | `[btTextureViewer]` | 缩放 | 接收请求并应答 | &#x2610; | null

测试环境（与与运行环境一致，

被测模块 --> 单元测试 --> 集成测试  ->> 确认测试  --> 系统测试
（测试过程图）

### 系统部署需求

服务器端部署（应用服务器、数据服务器、备用网络服务器）

软件部署（需要哪些软件？多少套，型号）

客户端部署（安装包、浏览器）
（安装包的获取，认证？账户注册流程……）

### 系统验收需求

#### 验收的前提条件

	系统设计各项功能满足双方的需求约定；
	合同或合同附件规定的各类文档齐全；
	软件产品已置于配置管理之下；
	与业务需求的符合程度；
	已通过计算机软件确认测试，已通过系统测试；
	与预期结果的符合程度，包括不仅限于信息资源规划、业务流程再造需求及业务持续改进需求和业务指标评价体系的符合程度。

可运行+文档+培训

#### 验收方法

#### 验收步骤

#. 我方将保证实用性、稳定性、可维护性、灵活性、可操作性。
#. 初验 --> 终验 --> 项目交接

#### 验收内容和标准

本项目的验收工作应遵循以下标准：
	应用系统符合“合同”、“深化设计方案”、“实施方案”以及用户确认的“需求分析说明书”规定的全部功能和质量要求；
	不同安全性关键等级的软件均通过项目验收的各项测试，并且获得可接受的软件测评和信息安全测评结果；
	建设方要求的文档规范《关于加强市应急联动指挥系统工程项目建设档案管理工作的通知》。

数据库设计
----------

> 注：
>
> 这部分放在后期再完善。

### 引言

目的、背景、参考资料、定义

### 结构设计

数据库分布

逻辑结构设计

各数据库直接的数据交换

命名规则
+ 对象命名规范
+ 编码规范

### 表结构设计

btServer 子系统

btClient 子系统（PC 客户端、Web 客户端）

btAuth 子系统


### 数据字典设计

？什么是数据字典？……

### 数据存储设计


### 数据采集


UI 设计文档
-----------

### 引言



#### 目的

（本文档根据对相关资料的理解，通过对用户的交流，从满足用户业务应用需求的角度出发，
结合项目建设的实际情况，对应急管理平台系统的界面进行详细描述。）



#### 背景


本系统作为**系统的一个子系统，是其它相关子系统在统一规划的基础上进行同步建设的。
结合项目建设目标的要求及系统特点，进行定制开发和改造，从而实现整体规划目标。


#### 业务术语

MainWindow

Widget

Dialog

Dock

快捷键

二维纹理

编辑器

认证

保存

提交

上传

原图

: 不是吧………………


#### 参考资料

《Qt 界面设计？》

### 系统界面说明

浏览、索引（查找、搜索）、认证、编辑、提交更改（纹理修改是在另一个图层上，不修改原始图片）、
最终 blend 显示（二维 alpha blend，三维两个纹理 transparent blend）

#### 三维查看

#### 二维查看

#### 认证和登录

#### 二维编辑

#### 三维编辑

#### 确认编辑（列出编辑的地方和变动）

#### 提交变动

（后台审核后判断是否把编辑后的状态设为默认。）

系统现状
--------

#. &#x2611; 基本雏形
#. &#x2610; 细节和具体模块